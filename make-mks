#!/bin/sh -e

case "$0" in
    */*)
	cd $(dirname $0)
	;;
esac

# Bail if not under git
git rev-parse

trap 'rm -f src/src.mk lib/medida.mk lib/lib.mk' 0

message="# This file was generated by make-mks; don't edit it by hand."

# Use only files git knows about, to avoid picking up autogenrated
# files or other random cruft.  When adding a new file foo.cpp, you
# must run "git add -N foo.cpp" before running this script.
(cd src
 echo "$message"
 echo "SRC_H_FILES" = $(git ls-files '*.h' '*.[ih]pp' | tr " " "\n" | sort | uniq | egrep -v '(test|simulation)/' | tr "\n" " ")
 echo "SRC_CXX_FILES" = $(git ls-files '*.cpp' | tr " " "\n" | sort | uniq |  egrep -v '(test|simulation)/' | tr "\n" " ")
 echo "SRC_X_FILES" = $(git ls-files '*.x' | tr " " "\n" | sort | uniq | tr "\n" " ")
 echo "SRC_TEST_H_FILES" = $(git ls-files '*.h' '*.[ih]pp' | tr " " "\n" | egrep '(test|simulation)/' | tr "\n" " ")
 echo "SRC_TEST_CXX_FILES" = $(git ls-files '*.cpp' | tr " " "\n" | sort | uniq |  egrep '(test|simulation)/' | tr "\n" " ")
) > src/src.mk


# Hacks for shell third-party libraries without autoconf.  You may
# need to re-run this after updating submodules.

listall() {
    find "$@" -type f \
	 \( -name '*.[ch]' -o -name '*.[chi]pp' -o -name '*.cc' \) -print
}

(cd lib
 if test -f libmedida/src/medida/medida.h; then
     echo "$message"
     echo INTERNAL_MEDIDA_FILES = $(listall libmedida/src/medida)
 fi) > lib/medida.mk

(cd lib
 echo "$message"
 echo SOCI_FILES = $(listall soci/src/backends/sqlite3 soci/src/core)
 echo SOCI_PG_FILES = $(listall soci/src/backends/postgresql)

 echo SQLITE3_FILES = $(listall sqlite)
 echo UTIL_EXCEPT_EASYLOGGING_FILES = $(listall util http | grep -v easylogging)
 echo EASYLOGGING_FILES = $(listall util | grep easylogging)
 echo ASIO_H_FILES = $(listall asio/asio/include)
 # The following does not work without boost or -DASIO_STANDALONE=1
 #echo ASIO_CXX_FILES = asio/src/*.cpp
 echo ASIO_CXX_FILES = asio.cpp
 echo TRACY_CXX_FILES = tracy/TracyClient.cpp
 echo JSON_FILES = $(listall json)

 echo MISC_H_FILES = *.hpp $(listall autocheck cereal fmt)
) > lib/lib.mk

trap '' 0
